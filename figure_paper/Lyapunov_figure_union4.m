
clc
clear

x_axis=0:0.004:2;
y_axis=0:0.004:1;

m=size(x_axis,2);
n=size(y_axis,2);

u1=zeros(m*n,1);
u2=zeros(m*n,1);

min_u1=1000;
u2_max_set=0.97;

x1_1=zeros(m*n,1);
x2_1=zeros(m*n,1);

x1_2=zeros(m*n,1);
x2_2=zeros(m*n,1);

x1_3=zeros(m*n,1);
x2_3=zeros(m*n,1);


for i=1:m
    for j=1:n
        u1( (i-1)*n+j )=x_axis(i);
        u2( (i-1)*n+j )=y_axis(j);
    end
end

score=1;

% x=[2.26260901757271,8.12295522781848,-2.04756553103465,-2.33656247899178,0.333661807808694,4.59481376286424,-3.56458114562901,2.15294288697907,4.52696815681804,5.28617614242602,-1.92831829125231,-5.30979889326439,0.845712657787760,6.36305356604045,-1.71505935257175,0.134993230479151]
% x=[1.32398231631048,5.46181572977235,-4.91260300086755,2.36522431699661,1.22602478836516,2.45205022735778,-1.20667630878520,-1.25047489072932,4.56555587387179,1.91484405580935,-5.88351843663001,-2.31658017152014,1.18047521824211,7.63824962039687,-3.40799444808255,-0.279912750138425];

% x=[2.26 8.12 -2.05 -2.34  0.33  4.60 -3.56  2.15  4.53  5.2  -1.93 -5.31  0.85  6.36 -1.72 0.14]
% x=[2.26373166220404,8.12346151509147,-2.04466050690186,-2.31982244037531,0.342770505962535,4.60290820596742,-3.10701246048351,2.14600599139447,4.34637521512715,5.28518267536517,-1.92512023413130,-5.05869871030395,0.875592414098484,6.38624679137324,-1.78914686128763,0.114654592634981]
x=[2.26  8.12  -2.04  -2.32   0.34   4.60  -3.11   2.15   4.35  5.29 -1.93 -5.06  0.88  6.39  -1.79  0.11];


is_valid=true;
max_x1=0;
max_u1=0;
max_u2=0;
h=1000;
  
for i=1:m*n
    P1=[x(1), x(3)*h; 
         x(4)*h, x(2)*h^2];
    P2=[x(5), x(7)*h; 
        x(8)*h, x(6)*h^2];
    P3=[x(9), x(11)*h; 
        x(12)*h, x(10)*h^2];
    P4=[x(13), x(15)*h; 
        x(16)*h, x(14)*h^2];
   
    P1S=(P1+P1')/2; P2S=(P2+P2')/2; P3S=(P3+P3')/2; P4S=(P4+P4')/2;

    M1=[u1(i)-1,h; (u2(i)-1)/h,1];
    
    DV1=-(M1'*P1*M1-P1);
    DV2=-(M1'*P2*M1-P2);
    DV3=-(M1'*P3*M1-P3);
    DV4=-(M1'*P4*M1-P4);
    
    DV1S=(DV1+DV1')/2;  DV2S=(DV2+DV2')/2;  DV3S=(DV3+DV3')/2;  DV4S=(DV4+DV4')/2; 

    if(((DV1S(1,1)>0 && (4*DV1S(1,1)*DV1S(2,2)-(DV1S(1,2)+DV1S(2,1))^2>0) && P1S(1,1)>0 && (4*P1S(1,1)*P1S(2,2)-(P1S(1,2)+P1S(2,1))^2>0))||...
       (DV2S(1,1)>0 && (4*DV2S(1,1)*DV2S(2,2)-(DV2S(1,2)+DV2S(2,1))^2>0) && P2S(1,1)>0 && (4*P2S(1,1)*P2S(2,2)-(P2S(1,2)+P2S(2,1))^2>0))||...
       (DV3S(1,1)>0 && (4*DV3S(1,1)*DV3S(2,2)-(DV3S(1,2)+DV3S(2,1))^2>0) && P3S(1,1)>0 && (4*P3S(1,1)*P3S(2,2)-(P3S(1,2)+P3S(2,1))^2>0))||...
       (DV4S(1,1)>0 && (4*DV4S(1,1)*DV4S(2,2)-(DV4S(1,2)+DV4S(2,1))^2>0) && P4S(1,1)>0 && (4*P4S(1,1)*P4S(2,2)-(P4S(1,2)+P4S(2,1))^2>0))) &&...
       ~((u1(i)>=0 && u1(i)<=2 && u2(i)>=0 && u2(i)<=u2_max_set) && (u2(i)>=u1(i)/2 && u2(i)<=u1(i))))
        x1_1(i)=u1(i); x2_1(i)=u2(i);
    else
        x1_1(i)=0; x2_1(i)=0;
    end       
    
    if (((u1(i)>=0 && u1(i)<2 && u2(i)>=0 && u2(i)<=u2_max_set) && (u2(i)>u1(i)/2 && u2(i)<=u1(i)))&&...
       ((DV1S(1,1)>0 && (4*DV1S(1,1)*DV1S(2,2)-(DV1S(1,2)+DV1S(2,1))^2>0) && P1S(1,1)>0 && (4*P1S(1,1)*P1S(2,2)-(P1S(1,2)+P1S(2,1))^2>0))||...
        (DV2S(1,1)>0 && (4*DV2S(1,1)*DV2S(2,2)-(DV2S(1,2)+DV2S(2,1))^2>0) && P2S(1,1)>0 && (4*P2S(1,1)*P2S(2,2)-(P2S(1,2)+P2S(2,1))^2>0))||...
        (DV3S(1,1)>0 && (4*DV3S(1,1)*DV3S(2,2)-(DV3S(1,2)+DV3S(2,1))^2>0) && P3S(1,1)>0 && (4*P3S(1,1)*P3S(2,2)-(P3S(1,2)+P3S(2,1))^2>0))||...
        (DV4S(1,1)>0 && (4*DV4S(1,1)*DV4S(2,2)-(DV4S(1,2)+DV4S(2,1))^2>0) && P4S(1,1)>0 && (4*P4S(1,1)*P4S(2,2)-(P4S(1,2)+P4S(2,1))^2>0)))&&...
       (u1(i)~=0 && u2(i)~=0))
       x1_2(i)=u1(i); x2_2(i)=u2(i);
    else
       x1_2(i)=0; x2_2(i)=0;
    end

    if (((u1(i)>=0 && u1(i)<2 && u2(i)>=0 && u2(i)<=u2_max_set) && (u2(i)>= u1(i)/2 && u2(i)<=u1(i)))&&...
       ~((DV1S(1,1)>0 && (4*DV1S(1,1)*DV1S(2,2)-(DV1S(1,2)+DV1S(2,1))^2>0) && P1S(1,1)>0 && (4*P1S(1,1)*P1S(2,2)-(P1S(1,2)+P1S(2,1))^2>0))||...
       (DV2S(1,1)>0 && (4*DV2S(1,1)*DV2S(2,2)-(DV2S(1,2)+DV2S(2,1))^2>0) && P2S(1,1)>0 && (4*P2S(1,1)*P2S(2,2)-(P2S(1,2)+P2S(2,1))^2>0))||...
       (DV3S(1,1)>0 && (4*DV3S(1,1)*DV3S(2,2)-(DV3S(1,2)+DV3S(2,1))^2>0) && P3S(1,1)>0 && (4*P3S(1,1)*P3S(2,2)-(P3S(1,2)+P3S(2,1))^2>0))||...
       (DV4S(1,1)>0 && (4*DV4S(1,1)*DV4S(2,2)-(DV4S(1,2)+DV4S(2,1))^2>0) && P4S(1,1)>0 && (4*P4S(1,1)*P4S(2,2)-(P4S(1,2)+P4S(2,1))^2>0))) &&...
       (u1(i)~=0 && u2(i)~=0))
   
        x1_3(i)=u1(i); x2_3(i)=u2(i);
        if (u1(i)<min_u1)
            min_u1=u1(i);
        end 
    else
        x1_3(i)=0; x2_3(i)=0;
    end
    
end


% set(gcf,'position',[600,40,468,350],'PaperPositionMode','auto');
set(gcf,'position',[600,40,321,240],'PaperPositionMode','auto');
set(gcf,'color','w');

figure(1)
set(gca,'Position',[0.118503118503119 0.144444444444444 0.862785862785862 0.838888888888889]);
p1_axis = gca; 
scatter(x1_1,x2_1,0.1,...
                    'LineWidth',0.01,...  
                    'DisplayName','$ \mathcal K $',...
                    'MarkerEdgeColor',[0.0745098039215686 0.623529411764706 1],...
                    'MarkerFaceColor',[0.0745098039215686 0.623529411764706 1] ); 
hold on
scatter(x1_2,x2_2,0.1,...
                    'LineWidth',0.1,...  
                    'DisplayName','$ \mathcal M $',...
                    'MarkerEdgeColor',[0.568627450980392 0.258823529411765 0.858823529411765],...
                    'MarkerFaceColor',[0.568627450980392 0.258823529411765 0.858823529411765] ); 
hold on
scatter(x1_3,x2_3,0.1,...
                    'LineWidth',0.01,...
                    'DisplayName','$ \mathcal K_M $',...
                    'MarkerEdgeColor',[1 0.2 0.1],...
                    'MarkerFaceColor',[1 0.2 0.1] );

set(gca,'Linewidth',0.8,'FontSize',9,'FontName','Times New Roman','FontWeight','light');
xlabel('$ {{\hat{u}}_{1,k}} $','Interpreter','latex');
ylabel('$ {{\hat{u}}_{2,k}} $','Interpreter','latex');


% zone figure
set(groot,'defaultAxesLineStyleOrder','remove','defaultAxesColorOrder','remove');
subp1=axes('Position',[0.529595015576324 0.252380952380953 0.379942487419125 0.280952380952381]);
axes(subp1);            
scatter(x1_1,x2_1,0.1,...
                    'LineWidth',0.01,...  
                    'DisplayName','$ \mathcal K $',...
                    'MarkerEdgeColor',[0.0745098039215686 0.623529411764706 1],...
                    'MarkerFaceColor',[0.0745098039215686 0.623529411764706 1] ); 
hold on
scatter(x1_2,x2_2,0.1,...
                    'LineWidth',0.1,...  
                    'DisplayName','$ \mathcal M $',...
                    'MarkerEdgeColor',[0.568627450980392 0.258823529411765 0.858823529411765],...
                    'MarkerFaceColor',[0.568627450980392 0.258823529411765 0.858823529411765] ); 
hold on
scatter(x1_3,x2_3,0.1,...
                    'LineWidth',0.01,...
                    'DisplayName','$ \mathcal K_M $',...
                    'MarkerEdgeColor',[1 0.2 0.1],...
                    'MarkerFaceColor',[1 0.2 0.1] );
set(subp1,'xlim',[1.6 1.9]);
set(subp1,'Linewidth',0.8,'FontSize',8,'FontName','Times New Roman','FontWeight','light');
line([1.5,1.78],[0.97,0.97],'color','k','linestyle','--','Marker','v');
hold on
line([1.78,1.78],[0.97,0.7],'color','k','linestyle','--','Marker','v'); 
grid on;

annotation(figure(1),'textbox',...
    [0.671258072021073 0.260552451893233 0.000255814708945423 0.000403476101800193],...
    'String',{'1.78'},...
    'FontSize',8,...
    'FontName','Times New Roman',...
    'FitBoxToText','off');

annotation(figure(1),'textbox',...
    [0.44653802487113 0.524441340782122 0.000255814708945534 0.000403476101800249],...
    'String','0.97',...
    'FontSize',8,...
    'FontName','Times New Roman',...
    'FitBoxToText','off');

legend1 = legend(p1_axis,'show');
set(legend1,...
    'Box','on',...
    'Interpreter','latex',...
    'Position',[0.165061020949637 0.6625 0.211612266086015 0.195833333333333]);